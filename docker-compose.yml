#
# iparapheur
# Copyright (C) 2019-2022 Libriciel-SCOP
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#


#
# Do not modify this file, it will be reset on every update.
# Any modification will be lost
#
# To modify anything from here, you should use the separate `docker-compose.override.instance.yml` file,
# That will contain every overridden parameter.
#


volumes:
  matomo_internal_files: { }


services:


  nginx:
    image: nginx:1.21.6
    restart: unless-stopped
    tty: true
    mem_limit: 64M
    environment:
      - APPLICATION_HOST
      - KEYCLOAK_HOST
    volumes:
      - matomo_internal_files:/var/www/html
      - ./data/matomo/config/:/var/www/html/config/
      - ./data/matomo/plugins/:/var/www/html/plugins/
      - ./src/main/resources/nginx/iparapheur.conf.template:/etc/nginx/templates/iparapheur.conf.template
      - ${CERTIFICATE_FULLCHAIN_PATH}:/etc/nginx/ssl/fullchain.pem
      - ${CERTIFICATE_PRIVKEY_PATH}:/etc/nginx/ssl/privkey.pem
    ports:
      - "80:80"
      - "443:443"
    links:
      - matomo


  core:
    image: registry.libriciel.fr:443/public/signature/ip-core:1.1.6
    restart: unless-stopped
    tty: true
    mem_limit: 1G
    environment:
      - POSTGRES_HOST
      - POSTGRES_PORT
      - CORE_DB_USER
      - CORE_DB_PASSWORD
      - QUARTZ_DB_USER
      - QUARTZ_DB_PASSWORD
      - CONTENT_HOST
      - CONTENT_PORT
      - CONTENT_USER
      - CONTENT_PASSWORD
      - MATOMO_TOKEN
      - STATS_SERVICE_PROTOCOL
      - VAULT_UNSEAL_KEY
      - VAULT_TOKEN
      - APPLICATION_PROTOCOL
      - APPLICATION_HOST
      - KEYCLOAK_AUTH_PROTOCOL
      - KEYCLOAK_HOST
      - KEYCLOAK_PORT
      - KEYCLOAK_DB_DATABASE
      - KEYCLOAK_DB_USER
      - KEYCLOAK_DB_PASSWORD
      - KEYCLOAK_REALM
      - KEYCLOAK_CLIENT_ID
      - KEYCLOAK_CLIENT_SECRET
      - KEYCLOAK_RESTADMIN_PASSWORD
      - INITIAL_IPARAPHEUR_ADMIN_USER
      - SECRET_PROTOCOL
      - SECRET_HOST
      - SECRET_PORT
      - SMTP_HOST
      - SMTP_PORT
      - SMTP_USER
      - SMTP_PASSWORD
      - SMTP_ENABLE_AUTH
      - SMTP_MAIL_FROM
      - SMTP_ENABLE_SSL
      - SMTP_ENABLE_START_TLS
    depends_on:
      postgres:
        condition: service_healthy
      alfresco:
        condition: service_started
      workflow:
        condition: service_started
    external_links:
      - nginx:${APPLICATION_HOST}


  web:
    image: registry.libriciel.fr:443/public/signature/ip-web:1.2.4
    restart: unless-stopped
    tty: true
    mem_limit: 64M
    environment:
      - APPLICATION_URL=${APPLICATION_PROTOCOL}://${APPLICATION_HOST}
      - VERSION=%CI_COMMIT_REF_NAME%
      - KEYCLOAK_URL=${KEYCLOAK_AUTH_PROTOCOL}://${APPLICATION_HOST}/auth
      - KEYCLOAK_REALM
      - KEYCLOAK_CLIENT_ID=${KEYCLOAK_WEB_CLIENT_ID}
    volumes:
      - ${RGPD_DATA}:/usr/share/nginx/html/assets/rgpd.json


  workflow:
    image: registry.libriciel.fr/public/signature/workflow:1.6.4
    restart: unless-stopped
    tty: true
    mem_limit: 768M
    environment:
      - WORKFLOW_DB_USER
      - WORKFLOW_DB_PASSWORD
    depends_on:
      postgres:
        condition: service_healthy


  pes-viewer:
    image: registry.libriciel.fr:443/public/signature/pes-viewer:1.5.1
    restart: unless-stopped
    tty: true
    mem_limit: 1536M
    volumes:
      - ./data/pes-viewer/pesPJ:/pesPJ/


  libersign:
    image: registry.libriciel.fr/public/signature/libersign:1.11.4
    restart: unless-stopped
    tty: true
    mem_limit: 64M


  crypto:
    image: registry.libriciel.fr/public/signature/crypto:3.0.0
    restart: unless-stopped
    tty: true
    mem_limit: 1G


  pdf-stamp:
    image: registry.libriciel.fr/public/signature/pdf-stamp:2.6.0
    restart: unless-stopped
    tty: true
    mem_limit: 512M


  pastell-connector:
    image: registry.libriciel.fr/public/signature/pastell-connector:1.3.7
    restart: unless-stopped
    tty: true
    mem_limit: 512M
    environment:
      - POSTGRES_HOST=postgres
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - SECUREMAIL_DB_USER
      - SECUREMAIL_DB_PASSWORD


  external-signature-connector:
    image: registry.libriciel.fr/public/signature/external-signature-connector:1.2.5
    restart: unless-stopped
    tty: true
    mem_limit: 1G


  legacy-bridge:
    image: registry.libriciel.fr/public/signature/legacy-bridge:1.4.0
    restart: unless-stopped
    tty: true
    mem_limit: 512M
    depends_on:
      - core
    external_links:
      - nginx:${APPLICATION_HOST}
    environment:
      - KEYCLOAK_HOST
      - KEYCLOAK_PORT
      - APPLICATION_HOST
      - APPLICATION_PROTOCOL
      - KEYCLOAK_REALM
      - KEYCLOAK_CLIENT_ID
      - KEYCLOAK_WEB_CLIENT_ID
      - KEYCLOAK_CLIENT_SECRET
      - MAIL_FROM


  feeder:
    image: registry.libriciel.fr/public/signature/feeder:1.0.3
    restart: unless-stopped
    tty: true
    mem_limit: 1G
    extra_hosts:
      - "${APPLICATION_HOST}:host-gateway"
    environment:
      - PARAPHEUR_URL=${APPLICATION_PROTOCOL}://${APPLICATION_HOST}/ws-iparapheur
    volumes:
      - ./data/feeder/data:/opt/iParapheur-feeder
      - ./src/main/resources/feeder/application.properties:/config/application.properties


  alfresco:
    image: registry.libriciel.fr:443/public/signature/ip-alfresco:7.2.1.0
    restart: unless-stopped
    tty: true
    mem_limit: 1536M
    environment:
      - XMX_SIZE=768M
      - CONTENT_HOST
      - CONTENT_PORT
      - POSTGRES_HOST
      - POSTGRES_PORT
      - CONTENT_DB_USER
      - CONTENT_DB_PASSWORD
    depends_on:
      postgres:
        condition: service_healthy
      transform-core-aio:
        condition: service_started
      activemq:
        condition: service_started
    volumes:
      - ./data/alfresco:/usr/local/tomcat/alf_data


  transform-core-aio:
    image: alfresco/alfresco-transform-core-aio:2.6.0
    restart: unless-stopped
    tty: true
    mem_limit: 1280M
    environment:
      JAVA_OPTS: "-Xmx768M"


  # solr6:
  #   image: alfresco/alfresco-search-services:2.0.3
  #   mem_limit: 1G
  #   environment:
  #     #Solr needs to know how to register itself with Alfresco
  #     - SOLR_ALFRESCO_HOST=${CONTENT_HOST}
  #     - SOLR_ALFRESCO_PORT=${CONTENT_PORT}
  #     #Alfresco needs to know how to call solr
  #     - SOLR_SOLR_HOST=solr6
  #     - SOLR_SOLR_PORT=8983
  #     #Create the default alfresco and archive cores
  #     - SOLR_CREATE_ALFRESCO_DEFAULTS=alfresco,archive
  #     #HTTP by default
  #     - ALFRESCO_SECURE_COMMS=none
  #   ports:
  #     - "8983:8983"    # Browser port


  activemq:
    image: alfresco/alfresco-activemq:5.16.5-jre11-centos7
    restart: unless-stopped
    tty: true
    mem_limit: 512M
    environment:
      ACTIVEMQ_OPTS: "-Xms128M -Xmx256M"


  postgres:
    image: postgres:10.1
    restart: unless-stopped
    tty: true
    mem_limit: 512M
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - KEYCLOAK_DB_USER
      - KEYCLOAK_DB_PASSWORD
      - CONTENT_DB_USER
      - CONTENT_DB_PASSWORD
      - CORE_DB_USER
      - CORE_DB_PASSWORD
      - QUARTZ_DB_USER
      - QUARTZ_DB_PASSWORD
      - WORKFLOW_DB_USER
      - WORKFLOW_DB_PASSWORD
      - SECUREMAIL_DB_USER
      - SECUREMAIL_DB_PASSWORD
    command: postgres -c max_connections=500 -c log_min_messages=LOG
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./src/main/resources/postgres/docker-entrypoint-initdb.d/:/docker-entrypoint-initdb.d/


  redis:
    image: redis:6.2.1-alpine
    restart: unless-stopped
    tty: true
    mem_limit: 128M
    volumes:
      - ./data/redis:/data


  keycloak:
    image: quay.io/keycloak/keycloak:16.1.1
    restart: unless-stopped
    tty: true
    # https://www.keycloak.org/docs/latest/server_installation/
    mem_limit: 1536M
    environment:
      - KEYCLOAK_REALM
      - KEYCLOAK_CLIENT_ID
      - KEYCLOAK_WEB_CLIENT_ID
      - KEYCLOAK_CLIENT_SECRET
      - INITIAL_KEYCLOAK_ADMIN_USER
      - INITIAL_KEYCLOAK_ADMIN_PASSWORD
      - INITIAL_IPARAPHEUR_ADMIN_USER
      - INITIAL_IPARAPHEUR_ADMIN_PASSWORD
      - SMTP_HOST
      - SMTP_PORT
      - SMTP_USER
      - SMTP_PASSWORD
      - SMTP_ENABLE_AUTH
      - SMTP_MAIL_FROM
      - SMTP_ENABLE_SSL
      - SMTP_ENABLE_START_TLS
      - DB_VENDOR=postgres
      - DB_ADDR=postgres
      - DB_DATABASE=keycloak
      # ${KEYCLOAK_DB_DATABASE}
      - DB_USER=${KEYCLOAK_DB_USER}
      - DB_PASSWORD=${KEYCLOAK_DB_PASSWORD}
      # - KEYCLOAK_LOGLEVEL=TRACE
      # This file will be generated from the given JSON, by the script file
      - KEYCLOAK_IMPORT=/tmp/keycloak_env_var_patched.json
      - JAVA_OPTS_APPEND="-Dkeycloak.profile.feature.upload_scripts=enabled"
      # Here we replace the whole options, copying the defaults normally provided by KC, otherwise memory options are overriden at run time
      - JAVA_OPTS=-Xmx1G -Djava.net.preferIPv4Stack=true -Djboss.modules.system.pkgs=org.jboss.byteman -Djava.awt.headless=true
      - PROXY_ADDRESS_FORWARDING=true
      - KEYCLOAK_FRONTEND_URL=${APPLICATION_PROTOCOL}://${APPLICATION_HOST}/auth
    volumes:
      - ./src/main/resources/keycloak/startup-scripts:/opt/jboss/startup-scripts
      - ./src/main/resources/keycloak/keycloak.json:/tmp/keycloak.json
      # Resources to retrieve from iparapheur-theme pipeline artifact,
      # on https://gitlab.libriciel.fr/outils/chartegraphique/theme-libriciel-keycloak
      - ./src/main/resources/keycloak/themes/libriciel:/opt/jboss/keycloak/themes/libriciel
      - ./src/main/resources/keycloak/themes/iparapheur:/opt/jboss/keycloak/themes/iparapheur
      # Fixing this bug, temporally : https://issues.redhat.com/browse/KEYCLOAK-12896
      #     WARNING : The issue was closed, but the issue was not actually fixed, to date.
      #     The bug is easy to reproduce : On the first launch, the INITIAL_KEYCLOAK_ADMIN_USER/INITIAL_KEYCLOAK_ADMIN_PASSWORD variables will create the default user.
      #     On the second launch, Keycloak will crash, because the user already exist. The problematic line (l.2) was just commented out.
      - ./src/main/resources/keycloak/docker-entrypoint.sh:/opt/jboss/tools/docker-entrypoint.sh


  matomo:
    image: matomo:4.2.1-fpm
    restart: unless-stopped
    tty: true
    # https://fr.matomo.org/docs/requirements/ says 2Go for the entire VM.
    # We're assuming a generous 1G for the service, and a little bit for the DB.
    mem_limit: 1024M
    volumes:
      - matomo_internal_files:/var/www/html
      - ./data/matomo/config/:/var/www/html/config/
      - ./data/matomo/plugins/:/var/www/html/plugins/
    depends_on:
      - matomo-db
    environment:
      - MATOMO_DATABASE_HOST=matomo-db
      - MATOMO_DATABASE_USERNAME=${MATOMO_DB_USER}
      - MATOMO_DATABASE_PASSWORD=${MATOMO_DB_PASSWORD}
      - MATOMO_DATABASE_DBNAME=${MATOMO_DB_DATABASE}
    healthcheck:
      test: [ "CMD-SHELL", "test -f /var/www/html/matomo.php" ]
      interval: 10s
      timeout: 5s
      retries: 5
  matomo-db:
    image: mariadb:10.3.36
    restart: unless-stopped
    tty: true
    mem_limit: 256M
    volumes:
      - ./data/matomo-db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MATOMO_DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MATOMO_DB_DATABASE}
      - MYSQL_USER=${MATOMO_DB_USER}
      - MYSQL_PASSWORD=${MATOMO_DB_PASSWORD}


  vault:
    image: vault:1.6.7
    restart: unless-stopped
    tty: true
    mem_limit: 512M
    environment:
      - VAULT_ADDR=${SECRET_PROTOCOL}://${SECRET_HOST}:${SECRET_PORT}
      - VAULT_API_ADDR=${SECRET_PROTOCOL}://${SECRET_HOST}:${SECRET_PORT}
    cap_add:
      - IPC_LOCK
    command: vault server -config=/vault/config/vault.json
    volumes:
      - ./src/main/resources/vault/config:/vault/config
      - ./src/main/resources/vault/policies:/vault/policies
      - ./data/vault/data:/vault/data


  prometheus:
    image: prom/prometheus:v2.34.0
    mem_limit: 256M
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    volumes:
      - ./src/main/resources/prometheus/alert.rules:/etc/prometheus/alert.rules
      - ./src/main/resources/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
