#
# iparapheur
# Copyright (C) 2019-2023 Libriciel-SCOP
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.
#


#
# DO NOT MODIFY THIS FILE, IT WILL BE RESET ON EVERY UPDATE!
# ANY MODIFICATION WILL BE LOST!
#
# To modify any parameter available here, you should use a separate `docker-compose.override.yml` file,
# That will contain every overridden parameter.
#

name: iparapheur


volumes:
  matomo_internal_files: { }


services:


  nginx:
    image: registry.libriciel.fr:443/public/signature/ip-nginx:1.24.0.0
    restart: unless-stopped
    tty: true
    deploy:
      resources:
        limits:
          memory: 256M
    environment:
      - APPLICATION_HOST
      - KEYCLOAK_HOST
    volumes:
      - matomo_internal_files:/var/www/html
      - ${DATA_ROOT_DIR}/matomo/config/:/var/www/html/config/
      - ${DATA_ROOT_DIR}/matomo/plugins/:/var/www/html/plugins/
      - ${CERTIFICATE_FULLCHAIN_PATH}:/etc/nginx/ssl/fullchain.pem
      - ${CERTIFICATE_PRIVKEY_PATH}:/etc/nginx/ssl/privkey.pem
    ports:
      - "80:80"
      - "443:443"
    links:
      - matomo


  core:
    image: registry.libriciel.fr:443/public/signature/ip-core:1.6.5
    restart: unless-stopped
    tty: true
    deploy:
      resources:
        limits:
          memory: 2G
    environment:
      - POSTGRES_HOST
      - POSTGRES_PORT
      - CORE_DB_USER
      - CORE_DB_PASSWORD
      - QUARTZ_DB_USER
      - QUARTZ_DB_PASSWORD
      - CONTENT_HOST
      - CONTENT_PORT
      - CONTENT_USER
      - CONTENT_PASSWORD
      - MATOMO_TOKEN
      - STATS_SERVICE_PROTOCOL
      - VAULT_UNSEAL_KEY
      - VAULT_TOKEN
      - APPLICATION_PROTOCOL
      - APPLICATION_HOST
      - KEYCLOAK_AUTH_PROTOCOL
      - KEYCLOAK_HOST
      - KEYCLOAK_PORT
      - KEYCLOAK_DB_DATABASE
      - KEYCLOAK_DB_USER
      - KEYCLOAK_DB_PASSWORD
      - KEYCLOAK_REALM
      - KEYCLOAK_CLIENT_ID
      - KEYCLOAK_CLIENT_SECRET
      - KEYCLOAK_RESTADMIN_PASSWORD
      - INITIAL_IPARAPHEUR_ADMIN_USER
      - SECRET_PROTOCOL
      - SECRET_HOST
      - SECRET_PORT
      - SMTP_HOST
      - SMTP_PORT
      - SMTP_USER
      - SMTP_PASSWORD
      - SMTP_ENABLE_AUTH
      - SMTP_MAIL_FROM
      - SMTP_ENABLE_SSL
      - SMTP_ENABLE_START_TLS
      - APP_VERSION=%CI_COMMIT_REF_NAME%
      - GDPR_DECLARING_ENTITY_NAME
      - GDPR_DECLARING_ENTITY_ADDRESS
      - GDPR_DECLARING_ENTITY_SIRET
      - GDPR_DECLARING_ENTITY_APE_CODE
      - GDPR_DECLARING_ENTITY_PHONE_NUMBER
      - GDPR_DECLARING_ENTITY_MAIL
      - GDPR_DECLARING_ENTITY_DPO_NAME
      - GDPR_DECLARING_ENTITY_DPO_MAIL
      - GDPR_DECLARING_ENTITY_RESPONSIBLE_NAME
      - GDPR_DECLARING_ENTITY_RESPONSIBLE_TITLE
      - GDPR_HOSTING_ENTITY_NAME
      - GDPR_HOSTING_ENTITY_ADDRESS
      - GDPR_HOSTING_ENTITY_SIRET
      - GDPR_HOSTING_ENTITY_COMMENT
      - GDPR_MAINTENANCE_ENTITY_NAME
      - GDPR_MAINTENANCE_ENTITY_ADDRESS
      - GDPR_MAINTENANCE_ENTITY_SIRET
    depends_on:
      postgres:
        condition: service_healthy
      alfresco:
        condition: service_healthy
      workflow:
        condition: service_healthy
      keycloak:
        condition: service_started
    external_links:
      - nginx:${APPLICATION_HOST}


  web:
    image: registry.libriciel.fr:443/public/signature/ip-web:1.6.4
    restart: unless-stopped
    tty: true
    deploy:
      resources:
        limits:
          memory: 64M
    environment:
      - APPLICATION_URL=${APPLICATION_PROTOCOL}://${APPLICATION_HOST}
      - VERSION=%CI_COMMIT_REF_NAME%
      - KEYCLOAK_URL=${KEYCLOAK_AUTH_PROTOCOL}://${APPLICATION_HOST}/auth
      - KEYCLOAK_REALM
      - KEYCLOAK_CLIENT_ID=${KEYCLOAK_WEB_CLIENT_ID}


  workflow:
    image: registry.libriciel.fr/public/signature/workflow:1.7.4
    restart: unless-stopped
    tty: true
    deploy:
      resources:
        limits:
          memory: 768M
    environment:
      - WORKFLOW_DB_USER
      - WORKFLOW_DB_PASSWORD
    depends_on:
      postgres:
        condition: service_healthy


  pes-viewer:
    image: registry.libriciel.fr:443/public/signature/pes-viewer:2.0.5
    restart: unless-stopped
    tty: true
    deploy:
      resources:
        limits:
          memory: 1536M
    volumes:
      - ${DATA_ROOT_DIR}/pes-viewer/pesPJ:/pesPJ/


  libersign:
    image: registry.libriciel.fr/public/signature/libersign:3.0.2
    restart: unless-stopped
    tty: true
    deploy:
      resources:
        limits:
          memory: 64M


  crypto:
    image: registry.libriciel.fr/public/signature/crypto:3.0.5
    restart: unless-stopped
    tty: true
    deploy:
      resources:
        limits:
          memory: 1536M


  pdf-stamp:
    image: registry.libriciel.fr/public/signature/pdf-stamp:2.6.1
    restart: unless-stopped
    tty: true
    deploy:
      resources:
        limits:
          memory: 1G


  pastell-connector:
    image: registry.libriciel.fr/public/signature/pastell-connector:1.3.8
    restart: unless-stopped
    tty: true
    deploy:
      resources:
        limits:
          memory: 512M
    environment:
      - POSTGRES_HOST=postgres
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - SECUREMAIL_DB_USER
      - SECUREMAIL_DB_PASSWORD


  external-signature-connector:
    image: registry.libriciel.fr/public/signature/external-signature-connector:1.3.2
    restart: unless-stopped
    tty: true
    deploy:
      resources:
        limits:
          memory: 1G


  legacy-bridge:
    image: registry.libriciel.fr/public/signature/legacy-bridge:1.4.13
    restart: unless-stopped
    tty: true
    deploy:
      resources:
        limits:
          memory: 1536M
    depends_on:
      - core
    external_links:
      - nginx:${APPLICATION_HOST}
    environment:
      - KEYCLOAK_HOST
      - KEYCLOAK_PORT
      - APPLICATION_HOST
      - APPLICATION_PROTOCOL
      - KEYCLOAK_REALM
      - KEYCLOAK_CLIENT_ID
      - KEYCLOAK_WEB_CLIENT_ID
      - KEYCLOAK_CLIENT_SECRET
      - KEYCLOAK_SOAPUI_PASSWORD
      - MAIL_FROM


  alfresco:
    image: registry.libriciel.fr:443/public/signature/ip-alfresco:7.3.0.2
    restart: unless-stopped
    tty: true
    deploy:
      resources:
        limits:
          memory: 1536M
    environment:
      - CONTENT_HOST
      - CONTENT_PORT
      - CONTENT_USER
      - CONTENT_PASSWORD
      - POSTGRES_HOST
      - POSTGRES_PORT
      - CONTENT_DB_USER
      - CONTENT_DB_PASSWORD
    depends_on:
      postgres:
        condition: service_healthy
      transform-core-aio:
        condition: service_healthy
      activemq:
        condition: service_started
    volumes:
      - ${DATA_ROOT_DIR}/alfresco:/usr/local/tomcat/alf_data


  transform-core-aio:
    image: registry.libriciel.fr:443/public/signature/ip-alfresco-transform-core-aio:3.0.0.0
    restart: unless-stopped
    tty: true
    deploy:
      resources:
        limits:
          memory: 1280M


  # solr6:
  #   image: alfresco/alfresco-search-services:2.0.5
  #   deploy:
  #    resources:
  #      limits:
  #        memory: 1G
  #   environment:
  #     #Solr needs to know how to register itself with Alfresco
  #     - SOLR_ALFRESCO_HOST=${CONTENT_HOST}
  #     - SOLR_ALFRESCO_PORT=${CONTENT_PORT}
  #     #Alfresco needs to know how to call solr
  #     - SOLR_SOLR_HOST=solr6
  #     - SOLR_SOLR_PORT=8983
  #     #Create the default alfresco and archive cores
  #     - SOLR_CREATE_ALFRESCO_DEFAULTS=alfresco,archive
  #     #HTTP by default
  #     - ALFRESCO_SECURE_COMMS=none
  #   ports:
  #     - "8983:8983"    # Browser port


  activemq:
    image: hubdocker.libriciel.fr/alfresco/alfresco-activemq:5.16.5-jre11-rockylinux8
    restart: unless-stopped
    tty: true
    deploy:
      resources:
        limits:
          memory: 512M
    environment:
      ACTIVEMQ_OPTS: "-Xms128M -Xmx256M"


  postgres:
    image: registry.libriciel.fr:443/public/signature/ip-postgresql:10.23.1
    restart: unless-stopped
    tty: true
    deploy:
      resources:
        limits:
          memory: 1G
    environment:
      - POSTGRES_USER
      - POSTGRES_PASSWORD
      - KEYCLOAK_DB_USER
      - KEYCLOAK_DB_PASSWORD
      - CONTENT_DB_USER
      - CONTENT_DB_PASSWORD
      - CORE_DB_USER
      - CORE_DB_PASSWORD
      - QUARTZ_DB_USER
      - QUARTZ_DB_PASSWORD
      - WORKFLOW_DB_USER
      - WORKFLOW_DB_PASSWORD
      - SECUREMAIL_DB_USER
      - SECUREMAIL_DB_PASSWORD
    volumes:
      - ${DATA_ROOT_DIR}/postgres:/var/lib/postgresql/data


  redis:
    image: hubdocker.libriciel.fr/redis:6.2.12-alpine
    restart: unless-stopped
    tty: true
    deploy:
      resources:
        limits:
          memory: 128M
    volumes:
      - ${DATA_ROOT_DIR}/redis:/data


  keycloak:
    image: registry.libriciel.fr:443/public/signature/ip-keycloak:21.0.2.0
    command: start --optimized --import-realm
    restart: unless-stopped
    tty: true
    deploy:
      resources:
        limits:
          memory: 1536M
    environment:
      - KEYCLOAK_REALM
      - KEYCLOAK_CLIENT_ID
      - KEYCLOAK_WEB_CLIENT_ID
      - KEYCLOAK_CLIENT_SECRET
      - KEYCLOAK_ADMIN=$INITIAL_KEYCLOAK_ADMIN_USER
      - KEYCLOAK_ADMIN_PASSWORD=$INITIAL_KEYCLOAK_ADMIN_PASSWORD
      - INITIAL_IPARAPHEUR_ADMIN_USER
      - INITIAL_IPARAPHEUR_ADMIN_PASSWORD
      - KEYCLOAK_RESTADMIN_PASSWORD
      - KEYCLOAK_SOAPUI_PASSWORD
      - SMTP_HOST
      - SMTP_PORT
      - SMTP_USER
      - SMTP_PASSWORD
      - SMTP_ENABLE_AUTH
      - SMTP_MAIL_FROM
      - SMTP_ENABLE_SSL
      - SMTP_ENABLE_START_TLS
      - KC_DB_USERNAME=${KEYCLOAK_DB_USER}
      - KC_DB_PASSWORD=${KEYCLOAK_DB_PASSWORD}
      - KC_HOSTNAME=${APPLICATION_HOST}
      - KC_HOSTNAME_ADMIN=${APPLICATION_HOST}
      - JAVA_OPTS=-Xmx1G -Djava.net.preferIPv4Stack=true -Dfile.encoding=UTF-8


  matomo:
    image: hubdocker.libriciel.fr/matomo:4.2.1-fpm
    restart: unless-stopped
    tty: true
    # https://fr.matomo.org/docs/requirements/ says 2Go for the entire VM.
    # We're assuming a generous 1G for the service, and a little bit for the DB.
    deploy:
      resources:
        limits:
          memory: 1024M
    volumes:
      - matomo_internal_files:/var/www/html
      - ${DATA_ROOT_DIR}/matomo/config/:/var/www/html/config/
      - ${DATA_ROOT_DIR}/matomo/plugins/:/var/www/html/plugins/
    depends_on:
      - matomo-db
    environment:
      - MATOMO_DATABASE_HOST=matomo-db
      - MATOMO_DATABASE_USERNAME=${MATOMO_DB_USER}
      - MATOMO_DATABASE_PASSWORD=${MATOMO_DB_PASSWORD}
      - MATOMO_DATABASE_DBNAME=${MATOMO_DB_DATABASE}
    healthcheck:
      test: [ "CMD-SHELL", "test -f /var/www/html/matomo.php" ]
      interval: 10s
      timeout: 5s
      retries: 5


  matomo-db:
    image: hubdocker.libriciel.fr/mariadb:10.3.36
    restart: unless-stopped
    tty: true
    deploy:
      resources:
        limits:
          memory: 256M
    volumes:
      - ${DATA_ROOT_DIR}/matomo-db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=${MATOMO_DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MATOMO_DB_DATABASE}
      - MYSQL_USER=${MATOMO_DB_USER}
      - MYSQL_PASSWORD=${MATOMO_DB_PASSWORD}


  vault:
    image: registry.libriciel.fr/public/signature/ip-vault:1.7.10.2
    restart: unless-stopped
    tty: true
    deploy:
      resources:
        limits:
          memory: 512M
    environment:
      - VAULT_ADDR=${SECRET_PROTOCOL}://${SECRET_HOST}:${SECRET_PORT}
      - VAULT_API_ADDR=${SECRET_PROTOCOL}://${SECRET_HOST}:${SECRET_PORT}
    cap_add:
      - IPC_LOCK
    volumes:
      - ${DATA_ROOT_DIR}/vault/data:/vault/data


  prometheus:
    image: registry.libriciel.fr/public/signature/ip-prometheus:2.42.0.1
    deploy:
      resources:
        limits:
          memory: 256M
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
